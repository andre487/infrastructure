- name: Create app dir
  file:
    path: '{{ project_path_ }}'
    state: directory
  tags:
    - deploy
    - docker-compose-project

- name: Create data dir
  file:
    path: '{{ mongo_db_path_ }}'
    state: directory
  tags:
    - deploy
    - docker-compose-project

- name: Setup docker compose config
  template:
    src: '{{ docker_compose_file_ }}'
    dest: '{{ project_path_ }}/docker-compose.yml'
  register: docker_compose
  tags:
    - deploy
    - docker-compose-project

- name: Install to SystemD
  template:
    src: templates/docker-compose.service.j2
    dest: /etc/systemd/system/docker-compose-{{ http_domain }}.service
  register: systemd_installation
  tags:
    - deploy
    - docker-compose-project

- name: Reload SystemD
  systemd_service:
    daemon_reload: true
  when: systemd_installation.changed
  tags:
    - deploy
    - docker-compose-project

- name: Update app
  shell:
    cmd: docker compose pull
    chdir: '{{ project_path_ }}'
  tags:
    - deploy
    - docker-compose-project

- name: Enable and restart app
  systemd_service:
    name: docker-compose-{{ http_domain }}
    state: restarted
    enabled: true
  tags:
    - deploy
    - docker-compose-project

- name: Cleanup images
  shell:
    executable: /usr/bin/python3
    cmd: "{{ lookup('file', 'scripts/cleanup_docker_images.py') }}"
  tags:
    - deploy
    - docker-compose-project

- name: Docker clean
  shell:
    cmd: docker-clean
