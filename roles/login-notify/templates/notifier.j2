#!/usr/bin/env bash
# Autogenerated with Ansible
set -e

if [[ "$PAM_TYPE" != "open_session" ]] || [[ "$PAM_SERVICE" == "cron" ]] || [[ "$PAM_SERVICE" == "sudo" ]]; then
    exit 0
fi

email_text=$(
    echo "User: $PAM_USER"
    if [[ -n "$PAM_RUSER" ]]; then
      echo "Ruser: $PAM_RUSER"
    fi
    if [[ -n "$PAM_RHOST" ]]; then
      echo "Rhost: $PAM_RHOST"
    fi
    echo "Service: $PAM_SERVICE"
    echo "TTY: $PAM_TTY"
    echo "Date: $(date)"
    echo "Server: $(uname -a)"
)

mail -v \
    -a "From:login-notifier@andre.life" \
    -s "$(hostname) login: $PAM_USER" "{{ admin_email }}" \
    <<< "$email_text" \
    2> "/tmp/notify-login-mail.log"

echo "$email_text" > "/tmp/notify-login-mail.txt"
